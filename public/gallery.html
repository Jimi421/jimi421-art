<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gallery View</title>
  <link rel="stylesheet" href="/styles/styles.css" />
</head>
<body>
  <nav class="breadcrumb">
    <a href="/">Home</a> /
    <span id="groupLabel">Gallery</span>
  </nav>

  <header>
    <h2 id="groupTitle">Gallery</h2>
  </header>

  <main id="groupGallery" class="gallery-grid"></main>

  <script>
    const API_BASE = 'https://jimi421-art.jimi421.workers.dev';

    function getParams() {
      const url = new URL(window.location.href);
      return {
        group: url.searchParams.get('group') || 'root'
      };
    }

    async function loadGroupGallery() {
      const { group } = getParams();
      document.getElementById('groupLabel').textContent = group;
      document.getElementById('groupTitle').textContent = `ðŸ–¼ï¸ ${group.charAt(0).toUpperCase() + group.slice(1)} Collection`;

      const res = await fetch(`${API_BASE}/api/gallery?group=${encodeURIComponent(group)}`);
      const items = await res.json();
      const gallery = document.getElementById('groupGallery');
      gallery.innerHTML = '';

      const filtered = items.filter(item => item.key.startsWith(`${group}/`));
      if (!filtered.length) {
        gallery.innerHTML = '<p style="text-align:center;">No images found in this group.</p>';
        return;
      }

      for (const item of filtered.reverse()) {
        const card = document.createElement('div');
        card.className = 'card';

        const wrapper = document.createElement('div');
        wrapper.className = 'media-wrapper';

        const isVideo = item.key.match(/\.(mp4|mov|webm)$/i);
        const media = document.createElement(isVideo ? 'video' : 'img');
        media.src = `${API_BASE}${item.url}`;
        if (isVideo) media.controls = true;
        media.className = 'media';

        const star = document.createElement('div');
        star.className = 'favorite-star';
        star.textContent = 'â­';
        wrapper.appendChild(media);
        wrapper.appendChild(star);
        card.appendChild(wrapper);

        const caption = document.createElement('div');
        caption.className = 'caption';
        caption.textContent = ''; // will update after metadata fetch
        card.appendChild(caption);

        const filename = item.key.split('/').pop();

        try {
          const metaRes = await fetch(`${API_BASE}/api/metadata?group=${group}&filename=${filename}`);
          if (metaRes.ok) {
            const meta = await metaRes.json();
            caption.textContent = meta.title || filename;
            if (meta.favorite) card.classList.add('favorited');
          } else {
            caption.textContent = filename;
          }
        } catch {
          caption.textContent = filename;
        }

        card.onclick = () => {
          window.location.href = `/photo.html?group=${encodeURIComponent(group)}&filename=${encodeURIComponent(filename)}`;
        };

        gallery.appendChild(card);
      }
    }

    window.addEventListener('DOMContentLoaded', loadGroupGallery);
  </script>
</body>
</html>